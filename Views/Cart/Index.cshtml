@model HoangLongTH.Models.Cart
@{
    ViewBag.Title = "Giỏ hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* Animations */
    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-50px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @@keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }

    @@keyframes shimmer {
        0% {
            background-position: -1000px 0;
        }

        100% {
            background-position: 1000px 0;
        }
    }

    @@keyframes float {
        0%, 100% {
            transform: translateY(0px);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    .cart-wrap {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        position: relative;
    }

        /* Floating decorations */
        .cart-wrap::before,
        .cart-wrap::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            z-index: -1;
            animation: float 6s ease-in-out infinite;
        }

        .cart-wrap::before {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            top: -100px;
            right: -100px;
            animation-delay: 0s;
        }

        .cart-wrap::after {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #ff6b35 0%, #f9ca24 100%);
            bottom: -150px;
            left: -150px;
            animation-delay: 2s;
        }

    .cart-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #ff6b35;
        animation: slideInLeft 0.6s ease-out;
        position: relative;
        overflow: hidden;
    }

        .cart-header::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            height: 3px;
            width: 0;
            background: linear-gradient(90deg, #ff6b35, #f9ca24);
            animation: loadingBar 2s ease-in-out infinite;
        }

    @@keyframes loadingBar {
        0%, 100% {
            width: 0;
        }

        50% {
            width: 100%;
        }
    }

    .cart-header h1 {
        font-size: 32px;
        color: #333;
        font-weight: 600;
        position: relative;
    }

    /* Table Header */
    .cart-table-header {
        display: grid;
        grid-template-columns: 50px 2fr 1fr 1.2fr 1fr 120px;
        gap: 15px;
        padding: 15px 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        font-weight: 600;
        color: #555;
        margin-bottom: 15px;
        align-items: center;
        animation: fadeInUp 0.5s ease-out;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    /* Cart Item */
    .cart-item {
        display: grid;
        grid-template-columns: 50px 2fr 1fr 1.2fr 1fr 120px;
        gap: 15px;
        padding: 20px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        margin-bottom: 15px;
        align-items: center;
        transition: all 0.3s ease;
        animation: fadeInUp 0.6s ease-out backwards;
        position: relative;
        overflow: hidden;
    }

        .cart-item:nth-child(1) {
            animation-delay: 0.1s;
        }

        .cart-item:nth-child(2) {
            animation-delay: 0.2s;
        }

        .cart-item:nth-child(3) {
            animation-delay: 0.3s;
        }

        .cart-item:nth-child(4) {
            animation-delay: 0.4s;
        }

        .cart-item:nth-child(5) {
            animation-delay: 0.5s;
        }

        .cart-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .cart-item:hover::before {
            left: 100%;
        }

        .cart-item:hover {
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.15);
            border-color: #ff6b35;
            transform: translateY(-5px);
        }

    /* Product Info */
    .item-info {
        display: flex;
        gap: 15px;
        align-items: center;
    }

        .item-info img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

    .cart-item:hover .item-info img {
        transform: scale(1.1) rotate(2deg);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .item-name {
        font-weight: 600;
        color: #333;
        font-size: 16px;
        margin-bottom: 5px;
        line-height: 1.4;
        transition: color 0.3s;
    }

    .cart-item:hover .item-name {
        color: #ff6b35;
    }

    .item-category {
        font-size: 13px;
        color: #888;
        background: #f0f0f0;
        padding: 3px 10px;
        border-radius: 12px;
        display: inline-block;
        transition: all 0.3s;
    }

    .cart-item:hover .item-category {
        background: #ff6b35;
        color: white;
        transform: scale(1.05);
    }

    /* Price */
    .unit-price, .item-total {
        font-weight: 600;
        color: #ff6b35;
        font-size: 16px;
        transition: all 0.3s;
    }

    .cart-item:hover .unit-price,
    .cart-item:hover .item-total {
        transform: scale(1.1);
        color: #e05525;
    }

    /* Quantity Control */
    .item-price-qty {
        display: flex;
        justify-content: center;
    }

    .qty-control {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: white;
    }

        .qty-control button {
            width: 35px;
            height: 35px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 18px;
            color: #333;
            transition: all 0.2s;
        }

            .qty-control button:hover {
                background: #ff6b35;
                color: white;
                transform: scale(1.15);
            }

            .qty-control button:active {
                transform: scale(0.95);
            }

        .qty-control input {
            width: 50px;
            height: 35px;
            border: none;
            text-align: center;
            font-weight: 600;
            font-size: 15px;
            background: white;
        }

    /* Actions */
    .item-actions {
        text-align: center;
    }

    .btn-remove {
        padding: 8px 20px;
        border: 1px solid #dc3545;
        background: white;
        color: #dc3545;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }

        .btn-remove::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: #dc3545;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn-remove:hover::before {
            width: 200px;
            height: 200px;
        }

        .btn-remove:hover {
            color: white;
            transform: scale(1.05);
        }

        .btn-remove span {
            position: relative;
            z-index: 1;
        }

    /* Cart Summary */
    .cart-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 30px;
        padding: 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        color: white;
        flex-wrap: wrap;
        gap: 20px;
        animation: fadeInUp 0.8s ease-out 0.6s backwards;
        position: relative;
        overflow: hidden;
    }

        .cart-summary::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

    .summary-row {
        font-size: 16px;
        margin-bottom: 8px;
    }

        .summary-row.total {
            font-size: 24px;
            font-weight: 700;
            margin-top: 10px;
        }

        .summary-row .amount {
            color: #ffd700;
            display: inline-block;
            animation: pulse 2s ease-in-out infinite;
        }

    .btn-checkout, .btn-clear-all {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 15px;
        text-decoration: none;
        display: inline-block;
    }

    .btn-checkout {
        background: #28a745;
        color: white;
        margin-left: 10px;
        position: relative;
        overflow: hidden;
    }

        .btn-checkout::after {
            content: '→';
            position: absolute;
            right: 20px;
            transition: right 0.3s;
        }

        .btn-checkout:hover::after {
            right: 15px;
        }

        .btn-checkout:hover {
            background: #218838;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }

        .btn-checkout:active {
            transform: translateY(-1px);
        }

    .btn-clear-all {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 1px solid white;
    }

        .btn-clear-all:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .btn-clear-all:active {
            transform: scale(0.98);
        }

    /* Empty Cart */
    .text-center {
        text-align: center;
        animation: fadeInUp 0.6s ease-out;
    }

    .p-5 {
        padding: 60px 20px;
    }

        .p-5 h4 {
            margin-bottom: 20px;
            color: #666;
            font-size: 24px;
            animation: float 3s ease-in-out infinite;
        }

    .mt-3 {
        margin-top: 20px;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .cart-table-header {
            display: none;
        }

        .cart-item {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .item-info {
            flex-direction: column;
            text-align: center;
        }

        .cart-summary {
            flex-direction: column;
        }

        .summary-row.total {
            font-size: 20px;
        }
    }
</style>

<div class="cart-wrap">
    <div class="cart-header">
        <h1>🛒 Giỏ hàng của bạn</h1>
    </div>

    @if (Model == null || Model.CartItem == null || !Model.CartItem.Any())
    {
        <div class="p-5 text-center">
            <h4>Giỏ hàng của bạn đang trống.</h4>
            <a href="@Url.Action("Index", "Category")" class="btn-checkout mt-3">Mua sắm ngay</a>
        </div>
    }
    else
    {
        <div class="cart-table-header">
            <span></span>
            <span>Sản phẩm</span>
            <span>Đơn giá</span>
            <span>Số lượng</span>
            <span>Số tiền</span>
            <span>Thao tác</span>
        </div>

        foreach (var item in Model.CartItem)
        {
            var img = string.IsNullOrWhiteSpace(item.Product?.ProductImage)
                ? Url.Content("~/Content/imgs/no-image.png")
                : Url.Content(item.Product.ProductImage);
            var lineTotal = item.UnitPrice * item.Quantity;

            var productName = item.Product?.ProductName ?? "Tên sản phẩm không có";
            var categoryName = item.Product?.Category?.CategoryName ?? "Chưa phân loại";

            <div class="cart-item" data-product-id="@item.ProductID">
                <div></div>
                <div class="item-info">
                    <img src="@img" alt="@productName" />
                    <div>
                        <div class="item-name">@productName</div>
                        <span class="item-category">@categoryName</span>
                    </div>
                </div>

                <div class="unit-price">@item.UnitPrice.ToString("N0") đ</div>

                <div class="item-price-qty">
                    <div class="qty-control">
                        <button type="button" class="btn-minus">−</button>
                        <input type="number" name="quantity" value="@item.Quantity" min="1" readonly />
                        <button type="button" class="btn-plus">+</button>
                    </div>
                </div>

                <div class="item-total">@lineTotal.ToString("N0") đ</div>

                <div class="item-actions">
                    <button class="btn-remove" onclick="removeItem(@item.ProductID)"><span>Xóa</span></button>
                </div>
            </div>
        }

        <div class="cart-summary">
            <div>
                <div class="summary-row">
                    Tổng số lượng: <strong>@ViewBag.TotalQuantity sản phẩm</strong>
                </div>
                <div class="summary-row total">
                    Tổng tiền: <span class="amount">@ViewBag.TotalPrice.ToString("N0") đ</span>
                </div>
            </div>
            <div>
                @* NÚT XÓA TOÀN BỘ DÙNG ACTIONLINK, KHÔNG CẦN JS *@
                @Html.ActionLink(
                    "Xóa toàn bộ",
                    "ClearCart",
                    "Cart",
                    routeValues: null,
                    htmlAttributes: new { @class = "btn-clear-all" }
                )

                <a href="@Url.Action("Checkout", "Order")" class="btn-checkout">Thanh toán →</a>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".cart-item").forEach(item => {
                const input = item.querySelector('input[name="quantity"]');
                const id = item.dataset.productId;
                const minus = item.querySelector(".btn-minus");
                const plus = item.querySelector(".btn-plus");

                minus.addEventListener("click", () => updateQty(id, input, -1));
                plus.addEventListener("click", () => updateQty(id, input, 1));
            });

            function updateQty(id, input, diff) {
                let quantity = parseInt(input.value);
                quantity = Math.max(1, quantity + diff);
                input.value = quantity;

                // Gửi id, quantity theo dạng form-urlencoded cho MVC
                fetch('@Url.Action("UpdateQuantity", "Cart")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: 'id=' + encodeURIComponent(id) + '&quantity=' + encodeURIComponent(quantity)
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            document.querySelector('[data-product-id="' + id + '"] .item-total').textContent =
                                data.itemSubtotal.toLocaleString() + ' đ';
                            document.querySelector('.summary-row strong').textContent =
                                data.totalQuantity + ' sản phẩm';
                            document.querySelector('.summary-row.total .amount').textContent =
                                data.totalPrice.toLocaleString() + ' đ';
                        } else {
                            alert(data.message || 'Có lỗi xảy ra khi cập nhật số lượng.');
                        }
                    })
                    .catch(err => {
                        console.error('Lỗi cập nhật:', err);
                        alert('Có lỗi xảy ra. Vui lòng thử lại!');
                    });
            }

            // Xóa từng item
            window.removeItem = function (id) {
                if (confirm('Xóa sản phẩm này khỏi giỏ hàng?')) {
                    window.location.href = '@Url.Action("RemoveItem", "Cart")' + '?id=' + id;
                }
            };
        });
    </script>
}
