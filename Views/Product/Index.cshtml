@model IEnumerable<HoangLongTH.Models.Product>
@{
    ViewBag.Title = "Danh sách sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string keyword = ViewBag.SearchString as string;
    bool hasSearch = !string.IsNullOrWhiteSpace(keyword);
}

<style>
    .products-section {
        background: #f5f5f5;
        padding: 20px 0;
        min-height: 100vh;
    }

    .section-header {
        background: linear-gradient(135deg, #ff6b35, #f7931e, #ee4d2d);
        color: white;
        padding: 15px 20px;
        margin: -20px -15px 25px -15px;
        border-radius: 2px;
        box-shadow: 0 2px 8px rgba(238, 77, 45, 0.3);
        animation: slideInDown 0.5s ease;
        background-size: 200% 200%;
        animation: slideInDown 0.5s ease, gradientShift 3s ease infinite;
    }

    @@keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes gradientShift {
        0%, 100% {
            background-position: 0% 50%;
        }

        50 {
            background-position: 100% 50%;
        }
    }

    .section-header h2 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .section-header small {
        font-size: 0.9rem;
        opacity: .9;
    }

    .product-card {
        background: white;
        border: none;
        border-radius: 2px;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        animation: fadeInUp 0.5s ease backwards;
    }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(238, 77, 45, 0.2);
            border: 1px solid #ee4d2d;
        }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .product-image-wrapper {
        position: relative;
        overflow: hidden;
        width: 100%;
        aspect-ratio: 1 / 1;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .product-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .product-card:hover .product-image {
        transform: scale(1.1) rotate(2deg);
    }

    .discount-badge {
        position: absolute;
        top: 0;
        right: 0;
        background: rgba(255, 212, 36, 0.95);
        color: #ee4d2d;
        padding: 2px 6px;
        font-size: 11px;
        font-weight: 700;
        z-index: 1;
        animation: bounceIn 0.6s ease;
    }

    @@keyframes bounceIn {
        0% {
            transform: scale(0);
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
        }
    }

    .product-body {
        padding: 12px;
    }

    .product-title {
        font-size: 14px;
        line-height: 1.4;
        color: #333;
        margin-bottom: 8px;
        height: 40px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        text-decoration: none;
        transition: color 0.3s ease;
    }

        .product-title:hover {
            color: #ee4d2d;
            text-shadow: 0 0 1px rgba(238, 77, 45, 0.3);
        }

    .product-price-wrapper {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .product-price {
        color: #ee4d2d;
        font-size: 16px;
        font-weight: 600;
        animation: priceGlow 2s ease-in-out infinite;
    }

    @@keyframes priceGlow {
        0%, 100% {
            text-shadow: 0 0 5px rgba(238, 77, 45, 0);
        }

        50% {
            text-shadow: 0 0 10px rgba(238, 77, 45, 0.3);
        }
    }

    .product-sold {
        font-size: 12px;
        color: #767676;
        margin-top: 4px;
    }

    .product-actions {
        display: flex;
        gap: 8px;
    }

    .btn-detail {
        flex: 1;
        background: white;
        border: 1px solid #ee4d2d;
        color: #ee4d2d;
        font-size: 13px;
        padding: 6px 12px;
        border-radius: 2px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        display: inline-block;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

        .btn-detail::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(238, 77, 45, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .btn-detail:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-detail:hover {
            background: #fff5f3;
            color: #ee4d2d;
            border-color: #ee4d2d;
            transform: translateY(-2px);
        }

    .btn-cart {
        flex: 1;
        background: linear-gradient(to bottom, #ff6b35, #ee4d2d);
        border: none;
        color: white;
        font-size: 13px;
        padding: 6px 12px;
        border-radius: 2px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        display: inline-block;
        text-align: center;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

        .btn-cart::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn-cart:hover::after {
            width: 300px;
            height: 300px;
        }

        .btn-cart:hover {
            background: linear-gradient(to bottom, #ff7a47, #f05635);
            color: white;
            box-shadow: 0 4px 12px rgba(238, 77, 45, 0.5);
            transform: translateY(-2px);
        }

        .btn-cart:active {
            transform: translateY(0) scale(0.95);
        }

        .btn-cart i {
            margin-right: 4px;
            transition: transform 0.3s;
        }

        .btn-cart:hover i {
            animation: cartShake 0.5s ease;
        }

    @@keyframes cartShake {
        0%, 100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-3px);
        }

        75% {
            transform: translateX(3px);
        }
    }

    .empty-state {
        background: white;
        padding: 60px 20px;
        text-align: center;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

        .empty-state i {
            font-size: 80px;
            color: #ee4d2d;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .empty-state h4 {
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
        }

    @@media (max-width: 768px) {
        .col-product {
            padding: 4px;
        }

        .product-body {
            padding: 8px;
        }

        .product-title {
            font-size: 13px;
            height: 36px;
        }

        .product-price {
            font-size: 14px;
        }
    }
</style>

<section class="products-section">
    <div class="container">
        <div class="section-header">
            @if (hasSearch)
            {
                <h2>
                    <i class="fas fa-search"></i> Kết quả tìm kiếm
                    <small>cho từ khóa "<strong>@keyword</strong>"</small>
                </h2>
            }
            else
            {
                <h2><i class="fas fa-store"></i> Danh sách sản phẩm</h2>
            }
        </div>

        <div class="row">
            @if (Model != null && Model.Any())
            {
                var list = Model.ToList();
                for (int i = 0; i < list.Count; i++)
                {
                    var p = list[i];
                    var img = string.IsNullOrWhiteSpace(p.ProductImage)
                        ? Url.Content("~/Content/imgs/no-image.png")
                        : Url.Content(p.ProductImage);

                    <div class="col-6 col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-3 col-product">
                        <div class="product-card" style="animation-delay:@(i * 0.05)s">
                            <a href="@Url.Action("Details", "Product", new { id = p.ProductID })">
                                <div class="product-image-wrapper">
                                    <img src="@img" class="product-image" alt="@p.ProductName" />
                                </div>
                            </a>

                            <div class="product-body">
                                <a href="@Url.Action("Details", "Product", new { id = p.ProductID })"
                                   class="product-title"
                                   title="@p.ProductName">
                                    @p.ProductName
                                </a>

                                <div class="product-price-wrapper">
                                    <span class="product-price">
                                        @String.Format("{0:N0}₫", p.ProductPrice)
                                    </span>
                                </div>

                                <div class="product-actions mt-2">
                                    <a class="btn-detail"
                                       href="@Url.Action("Details", "Product", new { id = p.ProductID })">
                                        Chi tiết
                                    </a>

                                    <button type="button"
                                            class="btn-cart"
                                            onclick="buyNowFromList(@p.ProductID)">
                                        <i class="fas fa-cart-plus"></i> Mua
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fas fa-shopping-bag"></i>

                        @if (hasSearch)
                        {
                            <h4>Không tìm thấy sản phẩm phù hợp</h4>
                            <p>
                                Không có sản phẩm nào khớp với từ khóa
                                "<strong>@keyword</strong>". Bạn thử từ khóa khác nhé.
                            </p>
                        }
                        else
                        {
                            <h4>Chưa có sản phẩm nào</h4>
                            <p>Vui lòng thêm sản phẩm trong trang Admin.</p>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</section>

@section scripts{
    <script>
        // Mua ngay từ danh sách sản phẩm
        function buyNowFromList(productId) {
            $.ajax({
                url: '@Url.Action("AddItem", "Cart")',
                type: 'GET',
                data: { id: productId, quantity: 1 },
                success: function (res) {
                    if (res && res.success) {

                        if (window.CartManager) {
                            if (window.CartManager.setCount && typeof res.count === 'number') {
                                window.CartManager.setCount(res.count);
                            } else if (window.CartManager.increment) {
                                window.CartManager.increment(1);
                            }
                        }

                        window.location.href = '@Url.Action("Checkout", "Order")';
                    } else {
                        alert(res && res.message ? res.message : "Không thể thêm sản phẩm vào giỏ hàng.");
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        if (confirm("Bạn cần đăng nhập để tiếp tục. Đăng nhập ngay?")) {
                            window.location.href = '@Url.Action("Login", "Account")';
                        }
                    } else {
                        alert("Có lỗi xảy ra khi thêm vào giỏ hàng.");
                    }
                }
            });
        }
    </script>
}
