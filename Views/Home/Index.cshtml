@model HoangLongTH.Models.HomeViewModel
@{
    ViewBag.Title = "Trang chủ";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@functions {
    string CatSlug(int categoryId)
    {
        switch (categoryId)
        {
            case 1: return "phone";
            case 2: return "laptop";
            case 3: return "accessory";
            default: return "all";
        }
    }
    string CatLabel(int categoryId)
    {
        switch (categoryId)
        {
            case 1: return "Điện thoại";
            case 2: return "Laptop";
            case 3: return "Phụ kiện";
            default: return "Khác";
        }
    }
}

<style>
    :root {
        --shopee-primary: #EE4D2D;
        --shopee-hover: #d73211;
        --shopee-light: #fff3f0;
        --shopee-orange: #f69113;
        --text-dark: #333333;
        --text-gray: #757575;
        --border-light: #efefef;
        --bg-gray: #f5f5f5;
    }

    body {
        background-color: var(--bg-gray);
    }

    /* ================= HERO SLIDER ================= */
    .hero-section {
        max-width: 1200px;
        margin: 0 auto 30px;
        position: relative;
    }

    .hero-img {
        width: 100%;
        height: 320px;
        object-fit: contain;
        object-position: center;
    }

    @@media (max-width: 768px) {
        .hero-img {
            height: 200px;
        }
    }

    /* ================= PRODUCTS GRID ================= */
    .products-section {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px 40px;
    }

    .section-title {
        font-size: 1.4rem;
        font-weight: 700;
        margin: 10px 0 15px;
        color: var(--text-dark);
    }

    .filter-buttons {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 0;
        margin-bottom: 15px;
        background: #fff;
        box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    .filter-btn {
        padding: 12px 26px;
        border: none;
        background: transparent;
        border-bottom: 3px solid transparent;
        font-size: 0.9rem;
        cursor: pointer;
        color: var(--text-dark);
        transition: 0.2s;
    }

        .filter-btn:hover {
            background: var(--shopee-light);
            color: var(--shopee-primary);
        }

        .filter-btn.active {
            border-bottom-color: var(--shopee-primary);
            color: var(--shopee-primary);
            font-weight: 600;
        }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        gap: 12px;
        background: white;
        padding: 12px;
    }

    .product-card {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: 12px;
        overflow: hidden;
        padding-bottom: 12px;
        transition: 0.2s;
        position: relative;
    }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-color: var(--shopee-primary);
        }

        .product-card img {
            width: 100%;
            height: 190px;
            object-fit: contain;
            padding: 10px;
            background: #fff;
            transition: transform 0.2s;
        }

        .product-card:hover img {
            transform: scale(1.05);
        }

    .product-card-body {
        padding: 10px 10px 0;
    }

    .product-card h3 {
        font-size: 0.9rem;
        height: 40px;
        line-height: 1.3;
        margin-bottom: 6px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

        .product-card h3 a {
            text-decoration: none;
            color: var(--text-dark);
        }

    .product-card:hover h3 a {
        color: var(--shopee-primary);
    }

    .product-price-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }

    .product-price {
        font-size: 1rem;
        color: var(--shopee-primary);
        font-weight: 600;
    }

        .product-price::before {
            content: "₫";
            margin-right: 2px;
            font-size: 0.9rem;
        }

    .product-sold {
        font-size: 0.75rem;
        color: var(--text-gray);
    }

    /* Discount ribbon */
    .product-discount {
        position: absolute;
        top: 10px;
        left: 0;
        background: rgba(255, 212, 36, 0.95);
        color: var(--shopee-primary);
        font-size: 0.7rem;
        font-weight: 700;
        padding: 3px 8px;
        border-radius: 0 3px 3px 0;
        text-transform: uppercase;
    }

    /* Tag danh mục ở góc phải */
    .product-tag {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.65rem;
        padding: 3px 8px;
        border-radius: 999px;
        color: #fff;
        text-transform: uppercase;
    }

        .product-tag.phone {
            background: var(--shopee-primary);
        }

        .product-tag.laptop {
            background: #26aa99;
        }

        .product-tag.accessory {
            background: #f59e0b;
        }

    /* ========== 3 NÚT DẠNG HÀNG DỌC ========== */
    .product-actions-vertical {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 10px;
    }

    .action-v {
        width: 100%;
        padding: 9px 10px;
        font-size: 0.8rem;
        border-radius: 6px;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        text-decoration: none;
        white-space: nowrap;
    }

        .action-v i {
            font-size: 0.85rem;
        }

    .add-cart {
        background: var(--shopee-primary);
        color: #fff;
    }

        .add-cart:hover {
            background: var(--shopee-hover);
        }

    .buy-now {
        background: var(--shopee-orange);
        color: #fff;
    }

        .buy-now:hover {
            background: #e67e00;
        }

    .detail-btn {
        background: #fff;
        border: 1px solid var(--shopee-primary);
        color: var(--shopee-primary);
    }

        .detail-btn:hover {
            background: var(--shopee-light);
        }

    /* Empty state */
    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
        color: var(--text-gray);
    }
</style>

<!-- ========== HERO SLIDER ========== -->
<div id="heroCarousel" class="carousel slide carousel-fade hero-section" data-bs-ride="carousel" data-bs-interval="3500">
    <div class="carousel-inner">
        <div class="carousel-item active">
            <img src="~/Content/Uploads/kich-thuoc-banner-shopee-1.png" class="d-block w-100 hero-img" alt="Banner 1" />
        </div>
        <div class="carousel-item">
            <img src="~/Content/Uploads/penci-frbzpvmn1748416131.jpg" class="d-block w-100 hero-img" alt="Banner 2" />
        </div>
        <div class="carousel-item">
            <img src="~/Content/Uploads/20230723_Vne80hqk.jpg" class="d-block w-100 hero-img" alt="Banner 3" />
        </div>
    </div>

    <div class="carousel-indicators">
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2"></button>
    </div>
</div>

<!-- ========== SẢN PHẨM MỚI NHẤT ========== -->
<section class="products-section">
    <h3 class="section-title">Sản phẩm mới nhất</h3>

    <div class="filter-buttons">
        <button class="filter-btn active" onclick="filterProducts('all', event)">Tất cả</button>
        <button class="filter-btn" onclick="filterProducts('phone', event)">Điện thoại</button>
        <button class="filter-btn" onclick="filterProducts('laptop', event)">Laptop</button>
        <button class="filter-btn" onclick="filterProducts('accessory', event)">Phụ kiện</button>
    </div>

    <div class="products-grid" id="new-products-grid">
        @if (Model != null && Model.NewProducts != null && Model.NewProducts.Any())
        {
            int count = 0;
            var rnd = new Random();

            foreach (var p in Model.NewProducts)
            {
                count++;

                var cat = CatSlug(p.CategoryID);
                var catLabel = CatLabel(p.CategoryID);
                var img = string.IsNullOrWhiteSpace(p.ProductImage)
                    ? Url.Content("~/Content/imgs/no-image.png")
                    : Url.Content(p.ProductImage);
                var priceDisplay = p.ProductPrice.ToString("N0");

                var hasDiscount = (count % 3 == 0);
                var sold = rnd.Next(500, 9000);

                <div class="product-card" data-category="@cat">
                    @if (hasDiscount)
                    {
                        <div class="product-discount">GIẢM 15%</div>
                    }
                    <div class="product-tag @cat">@catLabel</div>

                    <a href="@Url.Action("Details", "Product", new { id = p.ProductID })">
                        <img src="@img" alt="@p.ProductName" />
                    </a>

                    <div class="product-card-body">
                        <h3>
                            <a href="@Url.Action("Details", "Product", new { id = p.ProductID })">
                                @p.ProductName
                            </a>
                        </h3>

                        <div class="product-price-wrapper">
                            <p class="product-price">@priceDisplay</p>
                            <span class="product-sold">Đã bán @sold</span>
                        </div>

                        <div class="product-actions-vertical">
                            <button class="action-v add-cart" onclick="addToCart(@p.ProductID)">
                                <i class="fas fa-shopping-cart"></i> Thêm giỏ
                            </button>

                            <button class="action-v buy-now" onclick="buyNow(@p.ProductID)">
                                <i class="fas fa-bolt"></i> Mua ngay
                            </button>

                            <a href="@Url.Action("Details", "Product", new { id = p.ProductID })"
                               class="action-v detail-btn">
                                <i class="fas fa-eye"></i> Chi tiết
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                🛒 Chưa có sản phẩm nào.
            </div>
        }
    </div>
</section>

<!-- ========== SẢN PHẨM NỔI BẬT (BÁN CHẠY) ========== -->
<section class="products-section">
    <h3 class="section-title">Sản phẩm nổi bật (bán chạy)</h3>

    <div class="products-grid">
        @if (Model != null && Model.BestSellerProducts != null && Model.BestSellerProducts.Any())
        {
            int count2 = 0;
            var rnd2 = new Random();

            foreach (var p in Model.BestSellerProducts)
            {
                count2++;

                var cat = CatSlug(p.CategoryID);
                var catLabel = CatLabel(p.CategoryID);
                var img = string.IsNullOrWhiteSpace(p.ProductImage)
                    ? Url.Content("~/Content/imgs/no-image.png")
                    : Url.Content(p.ProductImage);
                var priceDisplay = p.ProductPrice.ToString("N0");

                var hasDiscount = (count2 % 2 == 0); // có thể đổi text: "BÁN CHẠY"
                var sold = rnd2.Next(2000, 20000);

                <div class="product-card" data-category="@cat">
                    @if (hasDiscount)
                    {
                        <div class="product-discount">BÁN CHẠY</div>
                    }
                    <div class="product-tag @cat">@catLabel</div>

                    <a href="@Url.Action("Details", "Product", new { id = p.ProductID })">
                        <img src="@img" alt="@p.ProductName" />
                    </a>

                    <div class="product-card-body">
                        <h3>
                            <a href="@Url.Action("Details", "Product", new { id = p.ProductID })">
                                @p.ProductName
                            </a>
                        </h3>

                        <div class="product-price-wrapper">
                            <p class="product-price">@priceDisplay</p>
                            <span class="product-sold">Đã bán @sold</span>
                        </div>

                        <div class="product-actions-vertical">
                            <button class="action-v add-cart" onclick="addToCart(@p.ProductID)">
                                <i class="fas fa-shopping-cart"></i> Thêm giỏ
                            </button>

                            <button class="action-v buy-now" onclick="buyNow(@p.ProductID)">
                                <i class="fas fa-bolt"></i> Mua ngay
                            </button>

                            <a href="@Url.Action("Details", "Product", new { id = p.ProductID })"
                               class="action-v detail-btn">
                                <i class="fas fa-eye"></i> Chi tiết
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                Chưa có dữ liệu sản phẩm nổi bật.
            </div>
        }
    </div>
</section>

@section Scripts {
    <script>
        // Hero auto slide
        document.addEventListener("DOMContentLoaded", function () {
            new bootstrap.Carousel(document.querySelector('#heroCarousel'), {
                interval: 3500,
                ride: 'carousel'
            });
        });

        // Lọc theo danh mục (chỉ áp dụng cho list sản phẩm mới)
        function filterProducts(category, e) {
            if (e) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }

            document.querySelectorAll('#new-products-grid .product-card').forEach(card => {
                if (category === 'all' || card.dataset.category === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Kiểm tra đăng nhập
        var isAuthenticated = '@(Session["Username"] ?? "")' !== '';

        function updateCartCount() {
            $.get('@Url.Action("GetCartCount", "Cart")', function (data) {
                if (data && data.count !== undefined) {
                    $("#cart-count").text(data.count);
                }
            });
        }

        // Thêm vào giỏ
        function addToCart(productId) {
            if (!isAuthenticated) {
                if (confirm("Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng. Đăng nhập ngay?")) {
                    window.location.href = '@Url.Action("Login", "Account")';
                }
                return;
            }

            $.ajax({
                url: '@Url.Action("AddItem", "Cart")',
                type: 'GET',
                data: { id: productId, quantity: 1 },
                success: function (res) {
                    if (!res) {
                        alert("❌ Có lỗi xảy ra, vui lòng thử lại!");
                        return;
                    }

                    if (res.success === false) {
                        alert(res.message || "Không thể thêm sản phẩm vào giỏ.");
                        return;
                    }

                    if (res.count !== undefined) {
                        $("#cart-count").text(res.count);
                    } else if (typeof updateCartCount === "function") {
                        updateCartCount();
                    }

                    const toast = document.createElement('div');
                    toast.textContent = "✅ Đã thêm sản phẩm vào giỏ hàng!";
                    toast.style.position = "fixed";
                    toast.style.bottom = "30px";
                    toast.style.right = "30px";
                    toast.style.background = "#48bb78";
                    toast.style.color = "#fff";
                    toast.style.padding = "10px 18px";
                    toast.style.borderRadius = "8px";
                    toast.style.boxShadow = "0 2px 10px rgba(0,0,0,0.2)";
                    toast.style.zIndex = 9999;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2200);
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        alert("❌ Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng.");
                    } else {
                        alert("❌ Có lỗi khi thêm vào giỏ hàng. Vui lòng thử lại!");
                    }
                }
            });
        }

        // Mua ngay
        function buyNow(productId) {
            if (!isAuthenticated) {
                if (confirm("Bạn cần đăng nhập để mua hàng. Đăng nhập ngay?")) {
                    window.location.href = '@Url.Action("Login", "Account")';
                }
                return;
            }

            $.ajax({
                url: '@Url.Action("AddItem", "Cart")',
                type: 'GET',
                data: { id: productId, quantity: 1 },
                success: function (res) {
                    if (res && res.success) {
                        window.location.href = '@Url.Action("Checkout", "Order")';
                    } else {
                        alert("Không thể thêm sản phẩm để mua ngay.");
                    }
                },
                error: function () {
                    alert("Lỗi hệ thống khi mua ngay. Vui lòng thử lại!");
                }
            });
        }
    </script>
}
